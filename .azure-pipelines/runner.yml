trigger:
  branches:
    include:
      - '*'
    exclude:
      - refs/pull/*/head
  paths:
    exclude:
      - docs/*
      - .github/*

variables:
  buildConfiguration: Debug
  dotnetCoreSdkVersion: 3.1.107
  ddApiKey: $(DD_API_KEY)
  DD_DOTNET_TRACER_MSBUILD:

# Declare the datadog agent as a resource to be used as a pipeline service
resources:
  containers:
  - container: dd_agent
    image: datadog/agent
    ports:
    - 8126:8126
    env:
      DD_API_KEY: $(ddApiKey)
      DD_INSIDE_CI: true

jobs:

- job: runner

  pool:
    vmImage: windows-2019

  # Enable the Datadog Agent service for this job
  services:
    dd_agent: dd_agent

  steps:

  # Install the tracer latest stable release to attach the profiler to the build and test steps.
  # The script exposes the required environment variables to the following steps
  - task: PowerShell@2
    displayName: Install profiler latest release
    inputs:
      filePath: ./.azure-pipelines/setup_tracer.ps1

  - task: UseDotNet@2
    displayName: install dotnet core runtime 2.1
    inputs:
      packageType: runtime
      version: 2.1.x

  - task: UseDotNet@2
    displayName: install dotnet core runtime 3.0
    inputs:
      packageType: runtime
      version: 3.0.x

  - task: UseDotNet@2
    displayName: install dotnet core sdk 3.1
    inputs:
      packageType: sdk
      version: $(dotnetCoreSdkVersion)

  - task: DotNetCoreCLI@2
    displayName: dotnet build
    inputs:
      command: build
      configuration: $(buildConfiguration)
      arguments: -l:DatadogLogger,"$(DD_DOTNET_TRACER_MSBUILD)"
      projects: |
        src/**/*.csproj
        test/**/*.Tests.csproj
        benchmarks/**/*.csproj
        !src/Datadog.Trace.Tools.Runner/*.csproj
    env:
      DD_SERVICE_NAME: dd-tracer-dotnet

  - task: MSBuild@1
    displayName: tool build
    inputs:
      solution: src/Datadog.Trace.Tools.Runner/Datadog.Trace.Tools.Runner.proj
      msbuildArguments: /t:BuildTool /l:DatadogLogger,"$(DD_DOTNET_TRACER_MSBUILD)"
      maximumCpuCount: true
    env:
      DD_SERVICE_NAME: dd-tracer-dotnet-runner-tool

  - task: MSBuild@1
    displayName: standalone build
    inputs:
      solution: src/Datadog.Trace.Tools.Runner/Datadog.Trace.Tools.Runner.proj
      msbuildArguments: /t:BuildStandalone /l:DatadogLogger,"$(DD_DOTNET_TRACER_MSBUILD)"
      maximumCpuCount: true
    env:
      DD_SERVICE_NAME: dd-tracer-dotnet-runner-tool